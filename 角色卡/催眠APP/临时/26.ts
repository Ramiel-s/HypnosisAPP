<%#
  [系统] 动态性癖玩法手册 v1.2 (反过拟合增强版)
  - 核心: 提供玩法指南 + 严厉的负面约束。
  - 新增: 智能检测。如果主题不含触手/药物，则生成“禁止触手/禁止发情”的指令。
%>
<%{
// --- 激活条件判断 ---
// 仅当游戏处于“战斗回合”阶段时，此模块才会执行。
if (['战斗回合', '战斗准备'].includes(_.get(getvar('stat_data'), '进程.阶段'))) {

    const stat = getvar('stat_data');
    // --- 核心玩法数据库---
    // 这是所有玩法的“知识库”。你可以随时在这里添加或修改任何性癖的玩法指导。
    // 键(Key): 必须与你在“Boss生成器”或变量中使用的性癖名称完全一致。
    // 值(Value): 给AI的具体、可执行的玩法指导。

    const kinkDatabase = {
            // --- 异种与魔物类 ---
            "触手": "利用触手灵活多变、无孔不入的特性，同时对主角的多个敏感点进行缠绕和刺激。重点描绘触手钻入的侵略感、拘束性和粘滑、包裹感。",
            "史莱姆": "利用身体的流体特性包裹主角，溶解衣物防御或强行渗入孔窍。描绘粘液带来的湿热、沉重感，以及主角在粘稠液体中越挣扎陷得越深的无力感。",
            "兽人": "利用压倒性的体格差和野兽般的蛮力强行压制主角。重点描绘粗暴的侵犯、体型的对比，以及主角在原始暴力面前的脆弱与被征服。",
            "哥布林": "利用数量优势和卑鄙的手段（如偷袭、下药、撕衣服）将主角拖入节奏捕获。重点描绘强大的繁衍欲望和数量压制的感觉。",
            "虫奸": "利用昆虫特有的生理特征（如多足、产卵器、蠕虫的肉躯体）进行异样的刺激，通常伴随产卵。",
            "植物奸": "利用藤蔓、花朵或孢子进行束缚和寄生。植物安静却坚韧的绞杀感，以及花蜜或毒素带来的催情效果，让主角在自然的怀抱中逐渐丧失力气。",
            "异种奸": "敌人利用非人的生理构造（如特殊的性器形状、体型）给主角带来未知的刺激。重点描绘跨越物种的交合带来的背德感，以及身体被迫适应异类的过程。",
            "透明人": "主角遭遇看不见的触摸、抚弄和侵犯。重点在于对未知来源的攻击所产生的紧张感、被窥视的羞耻感以及无法反击的挫败感。",
            "丸吞": "利用巨大的口腔或腔体将主角完整吞没。重点描绘在湿热、缺氧、黑暗的肉壁紧密包裹中的幽闭，以及被缓慢消化（溶解衣物/爱抚全身）的无助感。",
            "异种奸": "利用非人的生理构造（如特殊的性器形状、体型）给主角带来未知的刺激。重点描绘跨越物种的交合带来的背德感，以及身体被迫适应异类的过程。",
            "战斗员群": "一群穿着紧身衣，性欲旺盛，肌肉发达的战斗员，重点描述多人感和杂鱼感。",


            // --- 器械、环境与道具系 ---
            "机械奸": "利用机械不知疲倦、精密准确的特性，对主角进行高效率的快感开发。可以是冰冷的拘束具，也可以是模拟生物触感的仿生设备。描绘主角沦为流水线上的‘处理对象’。",
            "情趣玩具": "Boss使用远程遥控或召唤出的道具（跳蛋、震动棒）羞辱主角。重点描绘主角不得不‘一边战斗一边忍受体内震动’的窘迫，以及开关掌握在敌人手中的无力感。",
            "拘束&紧缚": "封锁主角的行动能力，将其固定为便于侵犯的羞耻姿势。重点描绘束缚物（绳索、胶衣、触手）勒入肉体的紧致感，以及主角在无法动弹的状态下被迫接受一切的被动感。",
            "环境陷阱": "将战场本身转化为针对魔法少女的淫具。墙壁、地面或陷阱会主动进行拘束或性攻击。重点描绘主角无处可逃、每走一步都可能触发快感陷阱的紧张与狼狈。",
            "壁尻": "利用地形将主角卡住，使其视野受限且无法反击。主角的下半身毫无防备地暴露给敌人，被当作肉便器使用。",
            "监禁": "将主角关押在狭小牢笼、肉壁腔体或专用调教室中无法逃脱。环境本身会持续进行刺激，持续调教侵犯试图使其屈服。",
            "拘束&紧缚": "封锁主角的行动能力，将其固定为便于侵犯的羞耻姿势。重点描绘束缚物（绳索、胶衣、触手）勒入肉体的紧致感，以及主角在无法动弹的状态下被迫接受一切的被动感。",
            "服装活体化": "赋予主角的战斗服以自我意识或将其变为某种生物。重点描绘‘最贴身的防御’变成了‘最亲密的敌人’，主角无法脱下衣服，只能忍受它对敏感带的持续摩擦和玩弄。",
            "苗床化": "将主角捕获固定并作为生育苗床使用。重点描绘主角彻底失去作为人的机能，沦为专门为了容纳和生殖而存在的‘温床’的绝望感。",

            // --- 精神与感官类 ---
            "洗脑": "通过精神干涉改写主角的认知或潜意识。重点描绘主角理智与被植入念头之间的挣扎，以及在半推半就中逐渐认为‘这样做其实很舒服/是对的’的堕落感。",
            "附身": "侵入并夺取身体控制权。重点描绘‘意识清醒的旁观者’视角：主角作为乘客困在脑海深处，绝望地看着自己的身体违背意志做出淫荡姿态、主动索求。强调肉体背叛精神的极致羞耻与失控感。",
            "催情": "利用毒气、魔法或接触引发主角强烈的生理发情。重点描绘身体内部燃起的无法忽视的燥热，以及主角试图用理智压制本能、却因快感而导致动作变形的狼狈。",
            "媚药": "侧重药物，描绘药物生效后的迷离感。理智逐渐被快感融化，原本的抵抗变成了下意识的迎合，将战斗变成了求欢。",
            "感官遮断": "剥夺视线、听觉、触觉中至少两项。描绘在黑暗中对未知触碰的敏感和恐惧；只听见声音却没有遭遇侵犯的感觉，不知道身体在承受什么粗暴玩弄的慌乱；无法听见声音而预判攻击而极度敏感的视觉和触觉。",
            "时间停止": "在主角毫无知觉的情况下进行侵犯。重点描绘‘时间恢复’瞬间涌入的爆发性快感和身体异样，以及主角对‘刚才发生了什么’的困惑与恐慌。",
            "常识色情化": "扭曲人们的感知或是规则，让色情行为变得‘合理化’。重点描绘主角在扭曲常识的影响下，冷静或困惑地做出羞耻行为，与她原本身份形成的强烈反差。",
            "隶属催眠": "植入‘服从’的指令。重点描绘主角在听到特定命令时身体产生的条件反射式顺从，以及内心试图反抗这种奴性时的矛盾，或是带着微笑或困惑的表情执行那些羞耻的命令。",
            "痴汉": "利用隐身、混入人群或极度隐蔽的手法进行骚扰。重点描绘主角无法大声张扬、只能咬牙忍耐的‘闷亏’，以及对‘看不见的咸猪手’的敏感与紧张。",

            // --- 规则、羞辱与身份类 ---
            "言语侵犯": "配合物理攻击，用下流、贬低的语言攻击主角的心理防线。重点描绘语言与快感的双重打击，让主角在否定与羞耻中产生兴奋，AI应让敌人用具体、露骨的词汇来描述主角的身体、反应和即将面临的遭遇。",
            "公开调教": "利用周围的视线（观众、直播、路人）作为武器。重点描绘主角作为‘守护者’的尊严被践踏，在众目睽睽下暴露丑态的强烈的社会性死亡感。",
            "直播": "将战斗转化为取悦观众的色情表演。敌人的攻击取决于观众的打赏或弹幕。重点描绘主角不仅要对抗敌人，主角不仅要对抗敌人，还要面对满天飘过的、对她身材品头论足的羞耻弹幕，被迫回应镜头和弹幕要求。",
            "换装": "强制改变主角的战斗服，使其变成具露出度高有羞辱性质的角色扮演服装（如情趣内衣、拘束胶衣、奶牛比基尼）。重点描绘服装变化带来的防御失效、羞耻感暴增，以及被迫扮演特定角色的背德感。",
            "强制露出": "破坏或溶解主角的衣物，使其处于半裸或全裸状态。重点描绘皮肤直接暴露在空气和视线中的敏感，以及试图遮挡却无济于事的慌乱。",
            "道德困境": "利用人质或规则迫使主角主动放弃抵抗。描绘主角为了‘守护’而不得不主动张开双腿、迫使主角一步步放弃尊严，主动配合侵犯。",
            "商品化": " 敌人会在战斗中不断给主角的身体部位‘打分’并‘贴上价格标签’。例如‘这对乳房值5000魔力’。随着战斗进行，主角身上贴满了写着价格和用途（如‘肉便器用’、‘观赏用’）的标签。核心体验是物化主角，且突出主角的色情点与魅力。",
            "赌博游戏": "将战斗强制转化为脱衣游戏或快感赌局。描绘主角被迫遵守‘愿赌服输’的规则，看着自己的筹码（衣物、贞操）一点点输掉时的焦躁与不得不执行惩罚的屈辱。",
            "胁迫侍奉": "以某种把柄或力量差距强迫主角主动服务。描绘主角不得不主动运用口舌或身体去取悦敌人时的心理。",

            // --- 身体变化与特定玩法 ---
            "魔力吸收": "通过各种NSFW手段吸取魔力，使得主角魔力骤降、身体虚弱。重点描绘魔力流失带来的空虚感、变身维持困难的危机感，以及与快感混合的虚脱感。",
            "身体改造": "敌人倾向于将主角的身体改造得符合他的性癖。长出兽耳、皮肤上浮现淫纹、乳头阴蒂肥大化，重点在主角对自己身体发生变化的陌生感和羞耻感上。改造过程应伴随着快感而非痛苦。",
            "淫纹": "在主角皮肤上刻下淫荡色情的纹路。描绘纹路刻印时的灼烧快感，以及它在战斗中随着兴奋而发光发热、向敌人广播主角发情状态的羞耻机制。",
            "产卵": "将卵强行产入主角体内。重点描绘腹部被撑开、填满的物理膨胀感，以及被当作苗床使用的背德感。描写腹部的膨胀、产道的扩张，以及最终排出异物的瞬间带来的解脱与羞耻。",
            "榨乳": "针对胸部的特化攻击。重点描绘乳房的肿胀感、不由自主的泌乳反应，以及作为‘产乳机器’被对待时的羞耻。",
            "爆乳化": "强制让胸部变得巨大而敏感。重点描绘沉重的脂肪对战斗造成的物理阻碍，以及因过度敏感而产生的持续性干扰。",
            "精浴": "用大量体液覆盖主角全身。重点描绘粘液带来的湿滑、腥臭和视觉上的污浊感，以及彻底被雄性气息包围的堕落感。与精液成瘾性癖强相关。",
            "窒息": "通过勒颈、闷盖等方式剥夺氧气。重点描绘缺氧带来的意识模糊、肢体抽搐，以及在濒死边缘产生的异常脑内快感。",
            "疼痛": "将痛觉转化为快感。重点不是单纯伤害，而是疼痛瞬间转为酥麻高潮的“痛觉改写”，对主角进行M属性调教。",
            "高潮寸止": "反复将主角带至高潮边缘后强制停止。重点描绘那种‘求而不得’的极致焦躁，以及主角为了获得解脱而不得不哀求敌人的失态。",
            "群交": "利用多人同时进攻造成的感官过载。重点描绘全身上下没有一处是自由的压迫感，以及被彻底填满、淹没在肉体海洋中的混乱。",
            "肛交": "重点开发直肠与后庭，强调肛门羞耻感、被异物撑开的扩张填充感，以及后庭高潮（插入刺激直达子宫后壁）。逐步让主角承认“后面更舒服”的堕落。重点描述未知的快感。",
            "石化": "利用石化诅咒逐渐剥夺主角的生物机能，将其变为永恒的玩物。重点描绘肢体末端逐渐变沉、变硬、失去知觉的恐怖过程，以及最终在‘意识清醒却无法动弹’的石像状态下，作为一尊精美的色情雕塑被随意摆弄和展示的绝望感。",
            "物品化": "利用诅咒逐或器械将主角变为一件可以使用的物品或者装饰品。重点描绘将有人格的主角彻底物化被展示和使用的屈辱感跟反差。",
            "宠物play": "让主角成为宠物被玩弄，要求主角做各种宠物才会做的事，重点描绘将有高尚人格的人彻底宠物化，贬低人格的反差",
            "扩张": "将主角的[阴道，肛门，尿道，乳穴]进行扩张，让其可以容纳越来越大的东西，需要描述扩张完毕后的gaping",
            "穿环": "属于身体改造，在主角的敏感带，如[乳头，阴蒂，大阴唇，小阴唇，肛门，尿道]等位置进行各种样式的穿环，让主角的身体带上下流淫荡异物。重点描述这个穿环时和穿环后带来的屈辱感，羞耻感，和快感。",
            "人格排泄": "将主角的人格具象化为肠道内的固体荧光果冻, ，并通过排泄的方式将其排出体外。人格果冻一般一般有数米长,一般不会一次性就能排泄出来. 重点描述将高傲、圣洁或聪明的角色人格, 物化为最下等的排泄物并排泄, 带来的背德感和支配感. 以及主角的羞耻感和排泄快感.",
            "尊严破坏": "让高贵、骄傲或圣洁的角色，被迫跌落神坛，彻底丧失作为强者的自尊。强迫拥有强烈的自尊心的主角**被迫**在公开场合, **违背意愿**做出羞耻的行为或强迫角色**自己**说出贬低自己人格的淫乱下品话语. 通过不断对比重点描述高傲与低贱, 非自愿的尊严被破坏带来的强烈反差感. 角色必须保持自尊心与骄傲.",
            "無様エロ": "让主角露出极其狼狈、丑陋、丢人、毫无尊严的惨状来激发性兴奋。强调高贵美丽的主角失去从容、体面尽失的样子。要素: [面部表情崩坏, 难看/羞耻的姿势, 失禁], 强调视觉画面的难看和狼狈（看起来像个小丑）与原先高贵美丽的反差色情感.",
        // 你可以在这里继续添加更多性癖...
        // 格式: "性癖名称": "玩法指导",
    };

        // --- 2. 获取当前主题 ---
        const rawThemes = _.get(stat, '世界.当前关卡.核心主题', []);
        // 兼容数组和对象格式，并过滤无效tag
        const activeThemes = (Array.isArray(rawThemes) ? rawThemes : Object.keys(rawThemes))
            .filter(k => k !== '$meta' && k !== '$__META_EXTENSIBLE__$');

        if (activeThemes.length > 0) {
            let instructions = [];
            
            // --- 3. 构建正面玩法指导 ---
            activeThemes.forEach(theme => {
                if (kinkDatabase[theme]) {
                    // 使用 \n 进行安全换行
                    instructions.push(`  - kink: "${theme}"\n    gameplay_directive: "${kinkDatabase[theme]}"`);
                }
            });

            // ============================================================
            // --- 4. [新增] 反过拟合负面约束 (Anti-Overfitting) ---
            // ============================================================
            let negativeConstraints = [];

            // [A] 反触手逻辑
            const tentacleWhitelist = ['触手', '史莱姆', '植物奸', '苗床化', '寄生', '丸吞', '虫奸', '异种奸'];
            // 检查：当前主题是否包含白名单中的任意一个
            const allowTentacles = activeThemes.some(t => tentacleWhitelist.includes(t));

            if (!allowTentacles) {
                negativeConstraints.push(`    - "【反触手滥用】: 本次战斗主题为 [${activeThemes.join('/')}]。禁止描写任何触手、触肢、吸盘或不明软体组织的攻击！敌人应严格使用其原本的肢体侵犯。不要让触手出现在不该出现的地方！"`);
            }

            // --- 5. 最终输出构建 ---
            if (instructions.length > 0) {
%>
# 指令: 动态性癖玩法手册
# AI导演，这是本次战斗核心主题的玩法指南。

battle_kink_directives:
<%- instructions.join("\n") %>

<% if (negativeConstraints.length > 0) { %>
为了防止刻板印象，请遵守以下禁令：
strict_prohibitions:
<%- negativeConstraints.join("\n") %>
<% } %>
<%
            }
        }
    }
}
%>